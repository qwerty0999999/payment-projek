<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lacak Pesanan</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* --- STYLE KHUSUS --- */
        .search-input {
            width: 100%; padding: 15px; font-size: 16px; border: 2px solid #eee;
            border-radius: 10px; text-align: center; text-transform: uppercase;
            letter-spacing: 2px; transition: 0.3s; box-sizing: border-box; font-weight: bold; color: #333;
        }
        .search-input:focus { border-color: #0056b3; outline: none; box-shadow: 0 0 10px rgba(0, 86, 179, 0.1); }
        
        .error-msg {
            background: #fee2e2; color: #dc2626; padding: 10px; border-radius: 8px;
            font-size: 14px; text-align: center; margin-top: 15px; display: none;
            border: 1px solid #fecaca; animation: shake 0.3s;
        }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        .ticket-card {
            border: 1px solid #eee; border-radius: 15px; overflow: hidden;
            margin-top: 20px; animation: slideUp 0.4s ease-out; display: none;
        }
        .ticket-header { background: #f8f9fa; padding: 20px; text-align: center; border-bottom: 2px dashed #ddd; }
        .status-icon-large { font-size: 40px; margin-bottom: 10px; display: block; }
        .ticket-body { padding: 20px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #f1f1f1; padding-bottom: 12px; }
        .info-row:last-child { border-bottom: none; }
        .label { color: #777; font-size: 14px; }
        .value { font-weight: bold; color: #333; text-align: right; }

        /* BADGE STATUS DI DALAM TIKET */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-pending { background: #fff7ed; color: #c2410c; }
        .badge-lunas { background: #ecfdf5; color: #047857; }
        .badge-ditolak { background: #fef2f2; color: #dc2626; }

        .btn-print {
            background: #333; color: white; border: none; padding: 12px; border-radius: 8px;
            cursor: pointer; margin-top: 15px; font-weight: bold; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-print:hover { background: #555; }

        /* Tombol Hubungi Admin (Muncul jika Ditolak) */
        .btn-help {
            background: #dc2626; color: white; border: none; padding: 12px; border-radius: 8px;
            cursor: pointer; margin-top: 15px; font-weight: bold; width: 100%;
            text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-help:hover { background: #b91c1c; }

        @media print {
            body * { visibility: hidden; }
            #receiptArea, #receiptArea * { visibility: visible; }
            #receiptArea { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Courier New', monospace; color: black; }
            .no-print { display: none !important; }
            .receipt-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
            .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
            .receipt-footer { text-align: center; border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px; font-size: 12px; }
        }
        #receiptArea { display: none; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="font-size: 1.2rem; margin:0;">üîç Cek Status</h1>
            <a href="index.html" style="color:white; text-decoration:none; font-size:14px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px;">üè† Home</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0 0 5px; color: #0056b3;">Lacak Pesanan Anda</h2>
                <p style="color: #777; font-size: 14px; margin: 0;">Masukkan Kode Invoice yang Anda dapatkan.</p>
            </div>
            
            <form id="trackForm" style="max-width: 400px; margin: 0 auto;">
                <input type="text" id="invoiceInput" class="search-input" placeholder="INV-XXXXX" required>
                <button type="submit" class="btn" style="margin-top: 15px;">üîç Cari Sekarang</button>
                <div id="errorBox" class="error-msg">‚ö†Ô∏è <b>Kode Tidak Ditemukan!</b><br>Pastikan penulisan benar.</div>
            </form>
        </div>

        <div id="resultCard" class="card ticket-card">
            
            <div class="ticket-header" id="ticketHeader">
                <span id="statusIcon" class="status-icon-large">‚è≥</span>
                <h2 id="resStatusText" style="margin:0;">Menunggu Konfirmasi</h2>
                <p id="resStatusDesc" style="margin:5px 0 0; color:#666; font-size:13px;">Admin sedang mengecek mutasi bank.</p>
            </div>

            <div class="ticket-body">
                <div class="info-row">
                    <span class="label">No. Invoice</span>
                    <span class="value" style="color: #0056b3;" id="resInv">-</span>
                </div>
                <div class="info-row">
                    <span class="label">Tanggal</span>
                    <span class="value" id="resDate">-</span>
                </div>
                <div class="info-row">
                    <span class="label">Nama Pelanggan</span>
                    <span class="value" id="resName">-</span>
                </div>
                <div class="info-row">
                    <span class="label">Produk</span>
                    <span class="value" id="resProd">-</span>
                </div>
                <div class="info-row">
                    <span class="label">Status</span>
                    <span id="badgeStatus" class="badge">-</span>
                </div>
                <div class="info-row" style="border:none;">
                    <span class="label">Total Bayar</span>
                    <span class="value" style="font-size: 18px; color: #28a745;" id="resPrice">-</span>
                </div>

                <div id="printSection" style="display: none;">
                    <button onclick="window.print()" class="btn-print">üñ®Ô∏è Cetak Bukti Sah</button>
                    <p style="text-align: center; font-size: 12px; color: #aaa; margin-top: 10px;">Simpan bukti ini sebagai arsip.</p>
                </div>

                <div id="helpSection" style="display: none;">
                    <a href="#" onclick="alert('Silakan hubungi Admin via WhatsApp untuk konfirmasi ulang.')" class="btn-help">üìû Hubungi Admin</a>
                    <p style="text-align: center; font-size: 12px; color: #dc2626; margin-top: 10px;">Bukti transfer Anda mungkin tidak terbaca atau nominal salah.</p>
                </div>

            </div>
        </div>
    </div>

    <div id="receiptArea">
        <div class="receipt-header">
            <h2 style="margin:0;">TOKO ONLINE</h2>
            <p style="margin:5px 0;">BUKTI PEMBAYARAN</p>
            <p id="printDate" style="font-size: 12px;"></p>
        </div>
        <div style="margin-bottom: 10px;">
            <div class="receipt-row"><span>Invoice</span><span id="strukInv">INV-XXX</span></div>
            <div class="receipt-row"><span>Pelanggan</span><span id="strukName">Nama</span></div>
            <hr style="border-top: 1px dashed #000; border-bottom:none; margin: 5px 0;">
            <div class="receipt-row"><span id="strukProd">Produk</span><span id="strukPrice">Rp 0</span></div>
            <hr style="border-top: 1px dashed #000; border-bottom:none; margin: 5px 0;">
            <div class="receipt-row" style="font-weight: bold; font-size: 16px;"><span>TOTAL</span><span id="strukTotal">Rp 0</span></div>
            <div class="receipt-row" style="margin-top: 10px; justify-content:center;">
                <span style="font-weight: bold; border: 1px solid #000; padding: 2px 10px;">STATUS: LUNAS</span>
            </div>
        </div>
        <div class="receipt-footer"><p>Terima Kasih!</p></div>
    </div>

    <script>
        const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);

        document.getElementById('trackForm').onsubmit = async (e) => {
            e.preventDefault();
            const inv = document.getElementById('invoiceInput').value.trim();
            const btn = document.querySelector('.btn');
            const errorBox = document.getElementById('errorBox');
            const resultCard = document.getElementById('resultCard');
            
            btn.innerText = "Mencari...";
            errorBox.style.display = 'none';
            resultCard.style.display = 'none';
            
            try {
                const res = await fetch('/api/track', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ invoiceId: inv })
                });
                const data = await res.json();

                if (data.success) {
                    resultCard.style.display = 'block';
                    
                    // Isi Data Umum
                    document.getElementById('resInv').innerText = data.data.invoiceId;
                    document.getElementById('resDate').innerText = data.data.tanggal;
                    document.getElementById('resName').innerText = data.data.nama;
                    document.getElementById('resProd').innerText = data.data.produk;
                    document.getElementById('resPrice').innerText = formatRupiah(data.data.harga);
                    
                    // Variable UI
                    const header = document.getElementById('ticketHeader');
                    const icon = document.getElementById('statusIcon');
                    const title = document.getElementById('resStatusText');
                    const desc = document.getElementById('resStatusDesc');
                    const badge = document.getElementById('badgeStatus');
                    const printSec = document.getElementById('printSection');
                    const helpSec = document.getElementById('helpSection');

                    // Reset Badge Class
                    badge.className = 'badge';

                    // LOGIKA VISUAL BERDASARKAN STATUS
                    if (data.data.status === 'Lunas') {
                        // --- LUNAS (HIJAU) ---
                        header.style.background = '#d1fae5'; 
                        icon.innerText = '‚úÖ';
                        title.innerText = 'Pembayaran Lunas';
                        title.style.color = '#065f46';
                        desc.innerText = 'Pesanan Anda sedang diproses.';
                        badge.classList.add('badge-lunas');
                        badge.innerText = 'Lunas';
                        
                        printSec.style.display = 'block'; // Muncul tombol print
                        helpSec.style.display = 'none';   // Sembunyi tombol bantuan

                        // Isi Data Struk
                        document.getElementById('strukInv').innerText = data.data.invoiceId;
                        document.getElementById('strukName').innerText = data.data.nama;
                        document.getElementById('strukProd').innerText = data.data.produk;
                        document.getElementById('strukPrice').innerText = formatRupiah(data.data.harga);
                        document.getElementById('strukTotal').innerText = formatRupiah(data.data.harga);
                        document.getElementById('printDate').innerText = new Date().toLocaleString();

                    } else if (data.data.status === 'Ditolak') {
                        // --- DITOLAK (MERAH) ---
                        header.style.background = '#fee2e2'; 
                        icon.innerText = '‚ùå';
                        title.innerText = 'Pembayaran Ditolak';
                        title.style.color = '#dc2626';
                        desc.innerText = 'Bukti transfer tidak valid / Dana belum masuk.';
                        badge.classList.add('badge-ditolak');
                        badge.innerText = 'Ditolak';

                        printSec.style.display = 'none'; // Sembunyi tombol print
                        helpSec.style.display = 'block'; // Muncul tombol bantuan

                    } else {
                        // --- PENDING (KUNING) ---
                        header.style.background = '#fff3cd'; 
                        icon.innerText = '‚è≥';
                        title.innerText = 'Menunggu Verifikasi';
                        title.style.color = '#856404';
                        desc.innerText = 'Admin sedang mengecek mutasi bank.';
                        badge.classList.add('badge-pending');
                        badge.innerText = 'Pending';

                        printSec.style.display = 'none';
                        helpSec.style.display = 'none';
                    }

                } else {
                    errorBox.style.display = 'block'; // Tampilkan Error
                }
            } catch (err) {
                alert("Gagal koneksi.");
            } finally {
                btn.innerText = "üîç Cari Sekarang";
            }
        };
    </script>
</body>
</html>