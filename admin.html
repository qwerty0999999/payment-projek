<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Pro</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        fetch('/api/me').then(response => {
            if (response.status === 401) {
                window.location.href = 'login.html';
            }
        }).catch(() => {
            window.location.href = 'login.html';
        });
    </script>

    <style>
        /* --- STYLE UTAMA --- */
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: linear-gradient(180deg, #1e293b, #0f172a); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 25px; font-size: 20px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:10px; }
        .live-dot { width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .menu-label { font-size: 11px; text-transform: uppercase; color: #94a3b8; margin: 15px 15px 5px; font-weight: 600; }
        .menu-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #cbd5e1; border-radius: 8px; margin-bottom: 5px; font-size: 14px; cursor: pointer; }
        .menu-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .menu-link.active { background: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .user-profile { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); display:flex; align-items:center; gap:10px; }
        .avatar { width: 35px; height: 35px; background: white; border-radius: 50%; color: #333; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* KONTEN KANAN */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 600; color: #1e293b; margin: 0; }

        /* CARDS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; font-size: 12px; color: #64748b; text-transform: uppercase; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: #0f172a; margin-top: 5px; }
        .card-blue { border-left: 4px solid #3b82f6; } .card-green { border-left: 4px solid #10b981; } 
        .card-red { border-left: 4px solid #ef4444; } .card-yellow { border-left: 4px solid #f59e0b; }
        
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 30px; height: 350px; }
        .card-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* FORM & TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { padding: 15px; background: #f8fafc; color: #64748b; font-size: 13px; font-weight: 600; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 14px; vertical-align: middle; }
        
        /* --- PERBAIKAN ALIGNMENT FORM --- */
        .product-form-grid { 
            display: grid; 
            grid-template-columns: 2fr 1.5fr 1fr auto; /* Proporsi kolom lebih seimbang */
            gap: 15px; 
            align-items: end; /* Kunci agar semua elemen rata bawah */
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 12px; 
            font-weight: bold; 
            margin-bottom: 8px; 
            height: 18px; /* Tinggi label dikunci biar sejajar */
            display: block;
        }

        .form-input { 
            width: 100%; 
            padding: 0 15px; 
            height: 45px; /* Tinggi input fix */
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 14px; 
            margin: 0;
        }
        
        .btn-primary { 
            background: #3b82f6; color: white; border: none; padding: 0 25px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; 
            height: 45px; /* Tinggi tombol SAMA dengan input */
            line-height: 45px; 
            white-space: nowrap;
        }
        .btn-primary:hover { background: #2563eb; }

        @media screen and (max-width: 768px) {
            .product-form-grid { grid-template-columns: 1fr; }
        }

        /* UTILS */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .bg-lunas { background: #d1fae5; color: #065f46; } .bg-pending { background: #ffedd5; color: #9a3412; } .bg-ditolak { background: #fee2e2; color: #991b1b; }
        .btn-xs { padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; border: none; color: white; font-weight: bold; margin-right: 5px; }
        .btn-accept { background: #3b82f6; } .btn-reject { background: #ef4444; } .btn-delete { background: #fee2e2; color: #ef4444; }
        .invoice-badge { background: #eff6ff; color: #3b82f6; padding: 4px 8px; border-radius: 4px; font-weight: bold; cursor: pointer; border: 1px dashed #3b82f6; }
        .role-super { background: #fef08a; color: #854d0e; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .role-admin { background: #e2e8f0; color: #475569; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .log-time { font-size: 12px; color: #94a3b8; } .log-action { font-weight: bold; font-size: 13px; color: #333; } .log-detail { font-size: 12px; color: #64748b; }

        /* MODALS */
        .modal-backdrop { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; width: 350px; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: zoomIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @keyframes zoomIn { from { transform:scale(0.9); opacity:0; } to { transform:scale(1); opacity:1; } }
        #toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 50px; padding: 12px 25px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @media screen and (max-width: 768px) { .sidebar { position: fixed; left: -260px; z-index: 1000; height: 100%; } .sidebar.open { left: 0; } .main-content { width: 100%; padding: 15px; } }
    </style>
</head>
<body>

    <div id="toast">‚úÖ Kode berhasil disalin!</div>

    <div id="logoutModal" class="modal-backdrop" style="z-index: 9999;"><div class="modal-box"><h3 style="margin:0 0 10px;">Logging Out...</h3><p>Sampai jumpa!</p></div></div>
    <div id="successAlertModal" class="modal-backdrop" style="z-index: 10000;"><div class="modal-box"><div style="font-size: 50px; color: #10b981; margin-bottom: 10px;">‚úÖ</div><h3 style="margin: 0 0 10px;">Berhasil!</h3><p id="successMsg" style="color: #666; margin-bottom: 20px;">Aksi selesai.</p></div></div>
    <div id="confirmModal" class="modal-backdrop"><div class="modal-box"><div id="modalIcon" style="font-size:50px; margin-bottom:10px;">‚ùì</div><h3 id="modalTitle" style="margin:0 0 10px;">Konfirmasi?</h3><p id="modalDesc" style="color:#666;">...</p><div style="display:flex; gap:10px; justify-content:center; margin-top:20px;"><button onclick="closeModal('confirmModal')" style="padding:8px 20px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer;">Batal</button><button id="btnConfirmAction" onclick="" style="color:white; border:none; padding:8px 20px; border-radius:6px; cursor:pointer;">Ya</button></div></div></div>
    <div id="doubleCheckModal" class="modal-backdrop" style="background: rgba(220, 38, 38, 0.2);"><div class="modal-box" style="border: 2px solid #dc2626;"><div style="font-size:50px; margin-bottom:10px;">‚ö†Ô∏è</div><h3 style="margin:0 0 10px; color: #dc2626;">Yakin 100%?</h3><p style="color:#666; margin-bottom:20px; font-size: 13px;">Data ini akan <b>dihapus permanen</b>.</p><div style="display:flex; gap:10px; justify-content:center;"><button onclick="closeModal('doubleCheckModal')" style="background:#f1f5f9; color:#333; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Batal</button><button onclick="finalDelete()" style="background:#dc2626; color:white; border-none; padding:8px 20px; border-radius:6px; cursor:pointer;">YA, MUSNAHKAN</button></div></div></div>
    <div id="imageModal" onclick="this.style.display='none'" class="modal-backdrop"><img id="modalImg" src="" style="max-width:90%; max-height:90%; border-radius:10px; box-shadow: 0 0 30px rgba(255,255,255,0.2);"></div>

    <div class="sidebar">
        <div class="brand"><div class="live-dot"></div>Admin Panel</div>
        <div class="menu">
            <div class="menu-label">Utama</div>
            <div class="menu-link active" onclick="showPage('view-home', this)">üìä Dashboard</div>
            <div class="menu-link" onclick="showPage('view-orders', this)">üì¶ Pesanan Masuk</div>
            <div id="superMenuSection" style="display: none;">
                <div class="menu-label">Superuser</div>
                <div class="menu-link" onclick="showPage('view-users', this)">üë• Kelola Admin</div>
                <div class="menu-link" onclick="showPage('view-products', this)">üè∑Ô∏è Kelola Produk</div>
            </div>
        </div>
        <div class="user-profile">
            <div class="avatar">üë§</div>
            <div style="flex:1;"><div id="sideUsername" style="font-size:14px; font-weight:bold;">Guest</div><div id="sideRole" style="font-size:11px; color:#94a3b8;">...</div></div>
            <button onclick="manualLogout()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:18px;" title="Logout">‚èª</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="view-home" class="view-section active">
            <div class="top-header"><h2 class="page-title">Dashboard Ringkasan</h2></div>
            <div class="dashboard-grid">
                <div class="stat-card card-blue"><h3>Total Transaksi</h3><div class="value" id="totalTrx">0</div></div>
                <div class="stat-card card-green"><h3>Pendapatan</h3><div class="value" style="color:#10b981;" id="totalMoney">Rp 0</div></div>
                <div class="stat-card card-red"><h3>Ditolak</h3><div class="value" style="color:#ef4444;" id="rejectedCount">0</div></div>
                <div class="stat-card card-yellow"><h3>Pending</h3><div class="value" style="color:#f59e0b;" id="pendingCount">0</div></div>
            </div>
            <div class="chart-container"><h3 style="margin-top:0; color:#333;">üìà Grafik Penjualan (Lunas)</h3><canvas id="salesChart"></canvas></div>
        </div>

        <div id="view-orders" class="view-section">
            <div class="top-header">
                <h2 class="page-title">Manajemen Pesanan</h2>
                <div style="display:flex; gap:10px;"><a href="/api/export-excel" class="btn-primary" style="text-decoration:none; background:#10b981;">üì• Excel</a><button onclick="loadData()" class="btn-primary" style="background:#64748b;">üîÑ Refresh</button></div>
            </div>
            <div class="card-box">
                <input type="text" id="searchInput" onkeyup="filterTable()" class="form-input" placeholder="üîç Cari Invoice atau Nama..." style="margin-bottom: 15px;">
                <div style="overflow-x: auto;">
                    <table id="tabelData"><thead><tr><th width="60">Bukti</th><th>Invoice</th><th>Pelanggan</th><th>Produk</th><th>Status</th><th style="text-align:center;">Aksi</th></tr></thead><tbody id="trxBody"></tbody></table>
                    <p id="noDataMsg" style="text-align: center; padding: 30px; display: none; color: #94a3b8;">Data tidak ditemukan.</p>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section">
            <div class="top-header"><h2 class="page-title">Kelola Akun Admin</h2></div>
            <div class="card-box">
                <h4>Tambah Akun</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px;">
                    <input type="text" id="newUsername" class="form-input" placeholder="Username">
                    <input type="text" id="newPassword" class="form-input" placeholder="Password">
                    <select id="newRole" class="form-input"><option value="admin">Admin Biasa</option><option value="superuser">Superuser</option></select>
                    <button onclick="addUser()" class="btn-primary">‚ûï Simpan</button>
                </div>
            </div>
            <div class="card-box">
                <h4>Daftar Akun</h4>
                <table><thead><tr><th>Username</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="userTableBody"></tbody></table>
            </div>
            <div class="card-box" style="border-top: 4px solid #8b5cf6;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0;">üìú Log Aktivitas Sistem (Real-time)</h4>
                    <button onclick="loadLogs()" class="btn-xs btn-primary">Refresh Log</button>
                </div>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table>
                        <thead><tr><th width="100">Waktu</th><th>Admin</th><th width="100">Aksi</th><th>Detail</th></tr></thead>
                        <tbody id="logTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-products" class="view-section">
            <div class="top-header"><h2 class="page-title">Kelola Produk</h2></div>
            
            <div class="card-box">
                <h4>Daftar Produk Tersedia</h4>
                <div style="overflow-x: auto;">
                    <table>
                        <thead><tr><th>Nama Produk</th><th>Harga (Rp)</th><th>Stok</th><th style="text-align:center;">Aksi</th></tr></thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="card-box" id="productFormSection">
                <h4 id="prodFormTitle" style="margin-bottom: 15px;">‚ûï Tambah Produk Baru</h4>
                <input type="hidden" id="prodId">
                
                <div class="product-form-grid">
                    <div class="input-group">
                        <span class="input-label">Nama Produk</span>
                        <input type="text" id="prodNameInput" class="form-input" placeholder="Contoh: Paket Sultan">
                    </div>
                    <div class="input-group">
                        <span class="input-label">Harga (Rp)</span>
                        <input type="text" id="prodPriceInput" class="form-input" placeholder="0" onkeyup="formatCurrency(this)">
                    </div>
                    <div class="input-group">
                        <span class="input-label">Stok</span>
                        <input type="number" id="prodStockInput" class="form-input" placeholder="0">
                    </div>
                    <div>
                        <button onclick="saveProduct()" class="btn-primary" style="width: 100%;">üíæ Simpan Produk</button>
                    </div>
                </div>
                
                <div id="cancelEditContainer" style="display:none; text-align:right; margin-top:10px;">
                    <button onclick="resetProductForm()" style="background:none; border:none; color:#ef4444; cursor:pointer; text-decoration:underline;">Batal Edit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR'}).format(n);
        let allData = [], currentIdToProcess = null, salesChart = null, productList = [];

        function showPage(pageId, element) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(pageId).classList.add('active'); if(element) { document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active')); element.classList.add('active'); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showSuccess(msg) { 
            document.getElementById('successMsg').innerText = msg; 
            const m = document.getElementById('successAlertModal'); 
            m.style.display = 'flex'; 
            setTimeout(() => m.style.display='none', 1500);
        }
        
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') { input.value = ''; return; }
            input.value = new Intl.NumberFormat('id-ID').format(value);
        }

        function loadData() { fetch('/api/data').then(r=>r.json()).then(data => { allData = data.reverse(); updateTable(allData); updateStats(data); renderChart(data); }); }
        function updateTable(data) {
            const tbody = document.getElementById('trxBody'); tbody.innerHTML = '';
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">Belum ada data.</td></tr>'; return; }
            data.forEach(item => {
                let badge, btns;
                if(item.status === 'Pending') { badge='<span class="badge bg-pending">Pending</span>'; btns=`<button class="btn-xs btn-accept" onclick="openModal('accept', ${item.id})">‚úî</button><button class="btn-xs btn-reject" onclick="openModal('reject', ${item.id})">‚úï</button>`; }
                else { let cls = item.status === 'Lunas' ? 'bg-lunas' : 'bg-ditolak'; badge = `<span class="badge ${cls}">${item.status}</span>`; btns = `<button class="btn-xs btn-delete" onclick="openModal('delete', ${item.id})">üóëÔ∏è</button>`; }
                tbody.innerHTML += `<tr><td><img src="/uploads/${item.fileBukti}" style="width:40px; height:40px; border-radius:4px; cursor:pointer;" onclick="document.getElementById('imageModal').style.display='flex';document.getElementById('modalImg').src=this.src"></td><td><span class="invoice-badge" onclick="navigator.clipboard.writeText('${item.invoiceId}').then(()=>showSuccess('Kode disalin!'))">${item.invoiceId}</span><br><small style="color:#94a3b8">${item.tanggal}</small></td><td><b>${item.nama}</b></td><td>${item.produk}<br><small>${formatRupiah(item.harga)}</small></td><td>${badge}</td><td style="text-align:center;">${btns}</td></tr>`;
            });
        }
        function updateStats(data) { document.getElementById('totalTrx').innerText = data.length; document.getElementById('totalMoney').innerText = formatRupiah(data.filter(i => i.status === 'Lunas').reduce((a, c) => a + parseInt(c.harga), 0)); document.getElementById('pendingCount').innerText = data.filter(i => i.status === 'Pending').length; document.getElementById('rejectedCount').innerText = data.filter(i => i.status === 'Ditolak').length; }
        function renderChart(data) { const ctx = document.getElementById('salesChart').getContext('2d'); const salesData = {}; data.forEach(item => { if (item.status === 'Lunas') { salesData[item.tanggal] = (salesData[item.tanggal] || 0) + parseInt(item.harga); } }); const labels = Object.keys(salesData).reverse(); const values = Object.values(salesData).reverse(); if (salesChart) salesChart.destroy(); salesChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Pendapatan', data: values, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } }); }
        
        function checkAuth() {
            fetch('/api/me').then(r => r.json()).then(data => {
                document.getElementById('sideUsername').innerText = data.user; document.getElementById('sideRole').innerText = data.role.toUpperCase();
                if(data.role === 'superuser') { document.getElementById('superMenuSection').style.display = 'block'; document.getElementById('sideRole').classList.add('role-super'); loadUsers(); loadLogs(); loadProductsTable(); } else { document.getElementById('sideRole').classList.add('role-admin'); }
            });
        }

        function loadUsers() { fetch('/api/users').then(r=>r.json()).then(users => { const tbody = document.getElementById('userTableBody'); tbody.innerHTML = ''; users.forEach(u => { let status = u.isOnline ? '<span class="status-online">‚óè Online</span>' : '<span style="color:#ccc;">Offline</span>'; tbody.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.role}</td><td>${status}</td><td><button onclick="deleteUser('${u.username}')" style="color:red; border:none; background:none; cursor:pointer;">Hapus</button></td></tr>`; }); }); }
        function loadLogs() { fetch('/api/logs').then(r=>r.json()).then(logs => { const tbody = document.getElementById('logTableBody'); tbody.innerHTML = ''; logs.slice().reverse().slice(0, 20).forEach(l => { const timeStr = new Date(l.time).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'}); tbody.innerHTML += `<tr><td><span class="log-time">${timeStr}</span></td><td><b class="log-action">${l.username || '-'}</b></td><td class="log-action">${l.action || '-'}</td><td class="log-detail">${l.detail || '-'}</td></tr>`; }); }); }
        function addUser() { const u = document.getElementById('newUsername').value; const p = document.getElementById('newPassword').value; const r = document.getElementById('newRole').value; fetch('/api/users/add', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ newUser: u, newPass: p, newRole: r }) }).then(r=>r.json()).then(res => { if(res.success) { showSuccess('User dibuat!'); loadUsers(); } else alert(res.message); }); }
        function deleteUser(u) { if(confirm('Hapus user?')) fetch('/api/users/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ targetUser: u }) }).then(r=>r.json()).then(res => { if(res.success) { showSuccess('User Dihapus!'); loadUsers(); } else alert(res.message); }); }

        function loadProductsTable() {
            fetch('/api/products').then(r=>r.json()).then(products => {
                productList = products; const tbody = document.getElementById('productTableBody'); tbody.innerHTML = '';
                products.forEach(p => {
                    let stockDisplay = p.stock < 5 ? `<span style="color:red; font-weight:bold;">${p.stock} (Low)</span>` : p.stock;
                    tbody.innerHTML += `<tr><td><b>${p.name}</b></td><td>${formatRupiah(p.price)}</td><td>${stockDisplay}</td><td style="text-align:center;"><button onclick="editProduct(${p.id})" class="btn-xs btn-accept">Edit</button> <button onclick="deleteProduct(${p.id})" class="btn-xs btn-reject">Hapus</button></td></tr>`;
                });
            });
        }
        function editProduct(id) {
            const p = productList.find(x => x.id == id);
            document.getElementById('productFormSection').scrollIntoView({behavior: 'smooth'});
            document.getElementById('prodFormTitle').innerText = `‚úé Edit Produk: ${p.name}`;
            document.getElementById('prodId').value=p.id; document.getElementById('prodNameInput').value=p.name; 
            document.getElementById('prodPriceInput').value = new Intl.NumberFormat('id-ID').format(p.price);
            document.getElementById('prodStockInput').value=p.stock;
            document.getElementById('cancelEditContainer').style.display='block';
        }
        function resetProductForm() {
            document.getElementById('prodFormTitle').innerText = "‚ûï Tambah Produk Baru";
            document.getElementById('prodId').value = ''; document.getElementById('prodNameInput').value = '';
            document.getElementById('prodPriceInput').value = ''; document.getElementById('prodStockInput').value = '';
            document.getElementById('cancelEditContainer').style.display = 'none';
        }
        function saveProduct() {
            const id = document.getElementById('prodId').value; const name = document.getElementById('prodNameInput').value;
            const priceRaw = document.getElementById('prodPriceInput').value.replace(/\./g, ''); const stock = document.getElementById('prodStockInput').value;
            const endpoint = id ? '/api/products/update' : '/api/products/add';
            const body = { id: id, name: name, price: priceRaw, stock: stock };
            fetch(endpoint, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json()).then(res => { 
                if(res.success) { showSuccess("Produk Disimpan!"); loadProductsTable(); resetProductForm(); } else alert("Gagal menyimpan."); 
            });
        }
        function deleteProduct(id) { if(confirm('Hapus produk?')) fetch('/api/products/delete', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id: id }) }).then(r=>r.json()).then(res => { if(res.success) { showSuccess('Produk Dihapus!'); loadProductsTable(); } else alert("Gagal."); }); }

        function openModal(type, id) { currentIdToProcess = id; document.getElementById('confirmModal').style.display = 'flex'; const title = document.getElementById('modalTitle'); const btn = document.getElementById('btnConfirmAction'); const icon = document.getElementById('modalIcon'); if(type === 'accept') { icon.innerText='üí∏'; title.innerText='Terima?'; btn.style.background='#10b981'; btn.onclick = () => sendUpdate('/api/update', 'Pesanan Diterima!'); } else if(type === 'reject') { icon.innerText='‚ö†Ô∏è'; title.innerText='Tolak?'; btn.style.background='#ef4444'; btn.onclick = () => sendUpdate('/api/reject', 'Pesanan Ditolak.'); } else { icon.innerText='üóëÔ∏è'; title.innerText='Hapus?'; btn.style.background='#ef4444'; btn.onclick = () => { closeModal('confirmModal'); document.getElementById('doubleCheckModal').style.display='flex'; }; } }
        function finalDelete() { closeModal('doubleCheckModal'); sendUpdate('/api/delete', 'Data dihapus permanen.'); }
        function sendUpdate(url, msg) { fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id: currentIdToProcess}) }).then(() => { closeModal('confirmModal'); loadData(); showSuccess(msg); }); }
        function manualLogout() { if(confirm('Keluar?')) { document.getElementById('logoutModal').style.display='flex'; setTimeout(()=> window.location.href='/logout', 1000); } }
        function filterTable() { let filter = document.getElementById('searchInput').value.toUpperCase(); let rows = document.getElementById('trxBody').getElementsByTagName('tr'); let found = false; for(let row of rows) { let txt = row.innerText.toUpperCase(); if(txt.includes(filter)) { row.style.display=""; found=true; } else { row.style.display="none"; } } document.getElementById('noDataMsg').style.display = found ? 'none' : 'block'; }
        let timer; const TIMEOUT = 1 * 60 * 1000; function resetTimer() { clearTimeout(timer); timer = setTimeout(()=> {document.getElementById('logoutModal').style.display = 'flex'; setTimeout(() => window.location.href = '/logout', 3000);}, TIMEOUT); } window.onload = resetTimer; document.onmousemove = resetTimer; document.onkeypress = resetTimer; document.onclick = resetTimer; document.onscroll = resetTimer; setInterval(() => { loadData(); if(document.getElementById('superMenuSection').style.display === 'block') { loadUsers(); loadLogs(); } }, 3000);

        checkAuth(); loadData();
    </script>
</body>
</html>